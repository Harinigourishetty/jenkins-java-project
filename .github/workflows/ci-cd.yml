name: CI-CD Pipeline

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      MVN_HOME: /usr/share/maven
      SONAR_HOST_URL: "http://3.19.188.209:9000"
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      NEXUS_URL: "http://3.19.188.209:8081/repository/maven-releases/"
      NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
      NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

    steps:

    # Checkout
    - name: Checkout Code
      uses: actions/checkout@v4

    # Install Java
    - name: Install Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # Install Maven using supported action
    - name: Install Maven
      uses: stCarolas/setup-maven@v4
      with:
        maven-version: '3.9.5'

    # Cache Maven Dependencies
    - name: Cache Maven Packages
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: maven-

    # Build WAR
    - name: Build WAR with Maven
      run: mvn clean package

    # SonarQube
    - name: SonarQube Scan
      run: mvn sonar:sonar \
        -Dsonar.projectKey=jenkins-java-project \
        -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
        -Dsonar.login=${{ env.SONAR_TOKEN }}

    # Upload to Nexus
    - name: Upload Artifact to Nexus
      run: |
        echo "<settings>
                <servers>
                  <server>
                    <id>maven-snapshots</id>
                    <username>${{ env.NEXUS_USERNAME }}</username>
                    <password>${{ env.NEXUS_PASSWORD }}</password>
                  </server>
                </servers>
              </settings>" > settings.xml
        mvn deploy -s settings.xml

    # Docker Build
    - name: Build Docker Image
      run: |
        docker build -t java-image .
        docker tag java-image ${{ env.DOCKER_USERNAME }}/java-image:latest

    # Login to Docker Hub
    - name: Login to Docker Hub
      run: echo "${{ env.DOCKER_PASSWORD }}" | docker login -u "${{ env.DOCKER_USERNAME }}" --password-stdin

    # Push Image
    - name: Push Docker Image
      run: docker push ${{ env.DOCKER_USERNAME }}/java-image:latest

    # Deploy to Remote Tomcat
    - name: Deploy to Tomcat Container
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          docker stop tomcat || true
          docker rm tomcat || true
          docker pull ${{ env.DOCKER_USERNAME }}/java-image:latest
          docker run -d --name tomcat -p 8082:8080 ${{ env.DOCKER_USERNAME }}/java-image:latest
